@{
	ViewBag.Title = "D3.js";
}

@section style
{
	<link href="~/Content/codemirror.css" rel="stylesheet" />
	<link href="~/Content/mdn-like.css" rel="stylesheet" />
	<style>
		li {
			padding-left: 10px;
		}

		.CodeMirror {
			height: 600px;
		}
	</style>
}

@section header
{
	<h2 class="page-title">Data-Driven Documents<small> is a JavaScript library for manipulating documents based on data.</small></h2>
}

<div ng-app="mindMapApp" ng-controller="mindMapCtrl">
	<div class="row" style="font-size: 16px;">
		<div class="col-md-4">
			<ul>
				<li ng-repeat="node in nodes" ng-include="'../templates/treeView.html'"></li>
			</ul>
			
			<div id="CodeMirror"></div>
		</div>

		<div class="col-md-8">
			<div id="graphContainer"></div>
		</div>
	</div>
</div>

@section scripts
{
	<script src="~/Scripts/codemirror.js"></script>
	<script src="~/Scripts/vivagraph/vivagraph.min.js"></script>
	<script>
		'use strict';

		(function (ng) {
			
			var tEditor = CodeMirror(document.getElementById('CodeMirror'), {
				indentWithTabs: true,
				lineNumbers: true,
				theme: 'mdn-like'
			});

			var graphics = Viva.Graph.View.svgGraphics();
			graphics.node(function(node) {
				return Viva.Graph.svg('text')
					.text(node.data.value);
			})
				.placeNode(function(nodeUi, pos) {
					nodeUi.attr('x', pos.x).attr('y', pos.y);
				});

			var app = ng.module('mindMapApp', []);
			app.controller('mindMapCtrl', ['$scope', function($scope) {
				var graph = Viva.Graph.graph();
				var that = this;

				that.start = function() {
					graph.clear();

					var counter = 1;
					var array = tEditor.getValue().split('\n');
					var tempData = _.compact(_.map(array, function(el) {
						if ($.trim(el)) {
							counter++;
							return {
								value: el,
								id: counter,
								childs: [],
								level: that.getOffset(el) + 1
							};
						}
					}));

					var data = [{
						value: 'root',
						id: 1,
						parent: 0,
						childs: [],
					}];
					_.each(tempData, function(e) {
						data.push({
							value: e.value,
							id: e.id,
							parent: that.searchParent(tempData, e),
							childs: [],
						});
					});

					var graphData = [];
					_.each(data, function(e) {
						if (e.parent == 0) {
							graphData.push(e);
						} else {
							that.createHierarchy(graphData, e);
						}
					});

					that.buildGraph(graphData);
				};

				that.getOffset = function(obj) {
					return obj.match(/^\s{0,9}/)[0].length;
				};

				that.buildGraph = function(data) {
					var root = data[0];
					that.addToGraph(root);
					that.renderGraph();
				};

				that.searchParent = function(data, newNode) {
					var id = newNode.id - 2;
					for (var i = id; i >= 0; i--) {
						var elm = data[i];
						if (elm.level < newNode.level) {
							return elm.id;
						}
					}
					return 1;
				};

				that.createHierarchy = function(array, node) {
					_.each(array, function(e) {
						if (e.id === node.parent) {
							e.childs.push(node);
							return;
						} else {
							if (e.childs.length) {
								that.createHierarchy(e.childs, node);
							}
						}
					});
				};

				that.addToGraph = function(node) {
					graph.addNode(node.id, { value: node.value });
					_.each(node.childs, function(e) {
						graph.addNode(e.id, { value: e.value });
						graph.addLink(node.id, e.id);
						if (e.childs.length) {
							that.addToGraph(e);
						}
					});
				};

				that.renderGraph = function() {
					$('#placeHolder').remove();
					$("#graphContainer").append("<div style='width: 100%; height: 600px; background-color: rgba(51,51,51,0.4);' id='placeHolder'></div>");

					var renderer = Viva.Graph.View.renderer(graph, {
						container: document.getElementById('placeHolder'),
						graphics: graphics
					});

					renderer.run();
				}
				
				var filterThrottled = _.debounce(that.start, 2000);
				tEditor.on('change', filterThrottled);
			}]);

		})(angular);
	</script>
}